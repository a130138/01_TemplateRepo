# Azure Storage Acct Deploy

variables:
- group: "AzVarGroupOne"

- name: timestamp
  value: $(Get-Date -Format yyyyMMddhhmmss)

trigger:
  - none

pool:
  vmImage: windows-latest

steps:
# New folder with template file copy
- task: PowerShell@2
  inputs:
   targetType: inline
   script: |
      New-Item -Path $(System.DefaultWorkingDirectory)\$(AzItem) -ItemType Directory -Name $(AzItem).$(timestamp)
      Copy-Item $AzRepoFolder\$AzTemplateFolder\$(AzTemplateFileJson) -Destination $(System.DefaultWorkingDirectory)\$(AzItem).$(timestamp)
      Get-ChildItem $(System.DefaultWorkingDirectory)\$(AzItem).$(timestamp) -Recurse

# Insert variables into json
- task: PowerShell@2
  inputs:
    targetType: inline
    script: |
      (Get-Content $(AzDestinationFileJSON)) | Foreach-Object { 
          $_ -replace '@@AzName@@', 'testname' ` 
              -replace '@@AzTagEnv@@', 'POC' ` 
              -replace '@@AzTagOwn@@', 'jc' ` 
              -replace '@@AzSkuName@@', 'Premium_LRS'  ` 
                    -replace '@@AzSkuTier@@','Premium' ` 
                    -replace '@@AzLoc@@','East US 2' ` 
                    -replace '@@AzKind@@','Storage' ` 
          } | Set-Content $(AzDestinationFileJSON)