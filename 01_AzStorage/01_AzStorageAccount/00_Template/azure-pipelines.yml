# Azure Storage Deploy

name: $(TeamProject)_$(Build.DefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

# Set MyRunNumber
variables:
  MyRunNumber: '1.0.0-CI+$(Build.BuildNumber)'
  azureResourceManageConnection: ''
  resourceGroupName: ''
  location:  ''
  kind:  ''
    # kind of azure storage
  TagOwner:  ''
    # azure owner tag
  TagEnv:  ''
    # azure environment tag
  csmFileLink: ''
    # azuredeploy.json location (ensure using 'raw' URL for github)
  csmParametersFileLink: ''
    # azuredeployparameters.json location (ensure using 'raw' URL for github)
  filepath: ''
    # file path of repo after default directory (leave blank if using default directory)

trigger:
  - none

pool:
  vmImage: windows-latest

steps:
# Build Info
- script: echo $(MyRunNumber) # display MyRunNumber
- script: echo $(Build.BuildNumber) # display Run Number
- script: echo '$(Build.BuildNumber)' # outputs customized build number like project_def_master_20200828.1

# ARM Template - Copy and Save As New File
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      $timestamp = Get-Date -Format "MMddyyyhhmm"
      (Get-Contents $(System.DefaultWorkingDirectory))\$filepath\azuredeploy.json | Set-Contents $(System.DefaultWorkingDirectory)\azuredeploy$timestamp.json

# ARM Template - Update
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      $timestamp = Get-Date -Format "MMddyyyhhmm"
      (Get-Contents $(System.DefaultWorkingDirectory)\$filepath\azuredeploy$timestamp.json)

# ARM Template - Deployment
- task: AzureResourceManagerTemplateDeployment@3
  inputs:
    deploymentScope: Resource Group
      # Options: Resource Group, Management Group, Subscription
    azureResourceManagerConnection: $(azureResourceManageConnection)
      # ex - Dev_Azure_10002_CloudSandbox3(239c71f8-a24e-41d1-96f6-b4f834a1f615)
    action: Create Or Update Resource Group
      # Options: Create Or Update Resource Group, DeleteRG
    resourceGroupName: $(resourceGroupName)
      # Azure Resource Group name
    location: ${location}
      # ex - East US 2
    templateLocation: URL of the file
      # Options: URL of the file, Linked Artifact
    csmFileLink: $(csmFileLink)
      # azuredeploy.json location (ensure using 'raw' URL for github)
    csmParametersFileLink: $(csmParametersFileLink)
      # azuredeployparameters.json location (ensure using 'raw' URL for github)
    deploymentMode: Incremental
      # Options:  Incremental, Validation, Complete