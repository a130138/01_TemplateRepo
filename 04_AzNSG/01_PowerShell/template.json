{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "variables": {},
  "resources":
  [
      {
          "type": "Microsoft.Network/networkSecurityGroups/securityRules",
          "apiVersion": "2019-04-01",
          "name": "[concat(parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), '/AllowAzureCloudOutBound')]",
          "dependsOn":
            [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'))]"
            ],
          "properties":
            {
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "AzureCloud",
                "access": "Allow",
                "priority": 110,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
      },
      {
          "type": "Microsoft.Network/networkSecurityGroups/securityRules",
          "apiVersion": "2019-04-01",
          "name": "[concat(parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), '/AllowBastionCommunication')]",
          "dependsOn":
            [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'))]"
            ],
          "properties":
            {
                "protocol": "*",
                "sourcePortRange": "*",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "VirtualNetwork",
                "access": "Allow",
                "priority": 120,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges":
                  [
                      "8080",
                      "5701"
                  ],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
      },
      {
          "type": "Microsoft.Network/networkSecurityGroups/securityRules",
          "apiVersion": "2019-04-01",
          "name": "[concat(parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), '/AllowBastionHostCommunication')]",
          "dependsOn":
            [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'))]"
            ],
          "properties":
            {
                "protocol": "*",
                "sourcePortRange": "*",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "VirtualNetwork",
                "access": "Allow",
                "priority": 150,
                "direction": "Inbound",
                "sourcePortRanges": [],
                "destinationPortRanges":
                  [
                      "8080",
                      "5701"
                  ],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
      },
      {
          "type": "Microsoft.Network/networkSecurityGroups/securityRules",
          "apiVersion": "2019-04-01",
          "name": "[concat(parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), '/AllowGatewayManagerInBound')]",
          "dependsOn":
            [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'))]"
            ],
          "properties":
            {
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "GatewayManager",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 130,
                "direction": "Inbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
      },
      {
          "type": "Microsoft.Network/networkSecurityGroups/securityRules",
          "apiVersion": "2019-04-01",
          "name": "[concat(parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), '/AllowGetSessionInformation')]",
          "dependsOn":
            [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'))]"
            ],
          "properties":
            {
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "80",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "Internet",
                "access": "Allow",
                "priority": 130,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
      },
      {
          "type": "Microsoft.Network/networkSecurityGroups/securityRules",
          "apiVersion": "2019-04-01",
          "name": "[concat(parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), '/AllowHttpsInBound')]",
          "dependsOn":
            [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'))]"
            ],
          "properties":
            {
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "Internet",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 120,
                "direction": "Inbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
      },
      {
          "type": "Microsoft.Network/networkSecurityGroups/securityRules",
          "apiVersion": "2019-04-01",
          "name": "[concat(parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), '/AllowSshRdpOutbound')]",
          "dependsOn":
            [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'))]"
            ],
          "properties":
            {
                "protocol": "*",
                "sourcePortRange": "*",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "VirtualNetwork",
                "access": "Allow",
                "priority": 100,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges":
                  [
                      "22",
                      "3389"
                  ],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
      },
      {
          "type": "Microsoft.Network/networkSecurityGroups",
          "apiVersion": "2019-04-01",
          "name": "[parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name')]",
          "location": "westeurope",
          "dependsOn":
            [
                "[resourceId('Microsoft.Network/networkSecurityGroups/securityRules', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), 'AllowHttpsInBound')]",
                "[resourceId('Microsoft.Network/networkSecurityGroups/securityRules', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), 'AllowGatewayManagerInBound')]",
                "[resourceId('Microsoft.Network/networkSecurityGroups/securityRules', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), 'AllowBastionHostCommunication')]",
                "[resourceId('Microsoft.Network/networkSecurityGroups/securityRules', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), 'AllowSshRdpOutbound')]",
                "[resourceId('Microsoft.Network/networkSecurityGroups/securityRules', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), 'AllowAzureCloudOutBound')]",
                "[resourceId('Microsoft.Network/networkSecurityGroups/securityRules', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), 'AllowBastionCommunication')]",
                "[resourceId('Microsoft.Network/networkSecurityGroups/securityRules', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), 'AllowGetSessionInformation')]"
            ],
          "tags":
            {
                "Owner": "Joseph Cropper    ",
                "Environment": "POC"
            },
          "properties":
              {
                "securityRules":
                  [
                      {
                          "name": "AllowHttpsInBound",
                          "id": "[resourceId('Microsoft.Network/networkSecurityGroups/securityRules', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), 'AllowHttpsInBound')]",
                          "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                          "properties":
                            {
                                "protocol": "Tcp",
                                "sourcePortRange": "*",
                                "destinationPortRange": "443",
                                "sourceAddressPrefix": "Internet",
                                "destinationAddressPrefix": "*",
                                "access": "Allow",
                                "priority": 120,
                                "direction": "Inbound",
                                "sourcePortRanges": [],
                                "destinationPortRanges": [],
                                "sourceAddressPrefixes": [],
                                "destinationAddressPrefixes": []
                            }
                      },
                      {
                          "name": "AllowGatewayManagerInBound",
                          "id": "[resourceId('Microsoft.Network/networkSecurityGroups/securityRules', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), 'AllowGatewayManagerInBound')]",
                          "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                          "properties":
                            {
                                "protocol": "Tcp",
                                "sourcePortRange": "*",
                                "destinationPortRange": "443",
                                "sourceAddressPrefix": "GatewayManager",
                                "destinationAddressPrefix": "*",
                                "access": "Allow",
                                "priority": 130,
                                "direction": "Inbound",
                                "sourcePortRanges": [],
                                "destinationPortRanges": [],
                                "sourceAddressPrefixes": [],
                                "destinationAddressPrefixes": []
                            }
                      },
                      {
                          "name": "AllowBastionHostCommunication",
                          "id": "[resourceId('Microsoft.Network/networkSecurityGroups/securityRules', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), 'AllowBastionHostCommunication')]",
                          "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                          "properties":
                            {
                                "protocol": "*",
                                "sourcePortRange": "*",
                                "sourceAddressPrefix": "VirtualNetwork",
                                "destinationAddressPrefix": "VirtualNetwork",
                                "access": "Allow",
                                "priority": 150,
                                "direction": "Inbound",
                                "sourcePortRanges": [],
                                "destinationPortRanges":
                                  [
                                      "8080",
                                      "5701"
                                  ],
                                "sourceAddressPrefixes": [],
                                "destinationAddressPrefixes": []
                            }
                      },
                      {
                          "name": "AllowSshRdpOutbound",
                          "id": "[resourceId('Microsoft.Network/networkSecurityGroups/securityRules', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), 'AllowSshRdpOutbound')]",
                          "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                          "properties":
                            {
                                "protocol": "*",
                                "sourcePortRange": "*",
                                "sourceAddressPrefix": "*",
                                "destinationAddressPrefix": "VirtualNetwork",
                                "access": "Allow",
                                "priority": 100,
                                "direction": "Outbound",
                                "sourcePortRanges": [],
                                "destinationPortRanges":
                                  [
                                      "22",
                                      "3389"
                                  ],
                                "sourceAddressPrefixes": [],
                                "destinationAddressPrefixes": []
                            }
                      },
                      {
                          "name": "AllowAzureCloudOutBound",
                          "id": "[resourceId('Microsoft.Network/networkSecurityGroups/securityRules', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), 'AllowAzureCloudOutBound')]",
                          "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                          "properties":
                            {
                                "protocol": "Tcp",
                                "sourcePortRange": "*",
                                "destinationPortRange": "443",
                                "sourceAddressPrefix": "*",
                                "destinationAddressPrefix": "AzureCloud",
                                "access": "Allow",
                                "priority": 110,
                                "direction": "Outbound",
                                "sourcePortRanges": [],
                                "destinationPortRanges": [],
                                "sourceAddressPrefixes": [],
                                "destinationAddressPrefixes": []
                            }
                      },
                      {
                          "name": "AllowBastionCommunication",
                          "id": "[resourceId('Microsoft.Network/networkSecurityGroups/securityRules', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), 'AllowBastionCommunication')]",
                          "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                          "properties":
                            {
                                "protocol": "*",
                                "sourcePortRange": "*",
                                "sourceAddressPrefix": "VirtualNetwork",
                                "destinationAddressPrefix": "VirtualNetwork",
                                "access": "Allow",
                                "priority": 120,
                                "direction": "Outbound",
                                "sourcePortRanges": [],
                                "destinationPortRanges":
                                  [
                                      "8080",
                                      "5701"
                                  ],
                                "sourceAddressPrefixes": [],
                                "destinationAddressPrefixes": []
                            }
                      },
                      {
                          "name": "AllowGetSessionInformation",
                          "id": "[resourceId('Microsoft.Network/networkSecurityGroups/securityRules', parameters('networkSecurityGroups_AzureBastionSubnet_nsg_name'), 'AllowGetSessionInformation')]",
                          "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                          "properties":
                            {
                                "protocol": "*",
                                "sourcePortRange": "*",
                                "destinationPortRange": "80",
                                "sourceAddressPrefix": "*",
                                "destinationAddressPrefix": "Internet",
                                "access": "Allow",
                                "priority": 130,
                                "direction": "Outbound",
                                "sourcePortRanges": [],
                                "destinationPortRanges": [],
                                "sourceAddressPrefixes": [],
                                "destinationAddressPrefixes": []
                            }
                      }
                    ]
              }
      }
  ]
}